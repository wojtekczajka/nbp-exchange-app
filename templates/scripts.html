<script>
    let dateRanges = {};
    let availableDates = [];
    let chart;

    async function fetchData(url) {
        const response = await fetch(url);
        return response.json();
    }

    async function fetchDateRanges(table) {
        const data = await fetchData(`/date-ranges/${table}`);
        dateRanges[table] = data;
        updateDateRange(table);
    }

    async function fetchAvailableDates(table, year, month, currency) {
        const data = await fetchData(`/available-dates/${table}/${year}/${month}?currency=${currency}`);
        availableDates = data;
        highlightDatesWithRecords();
    }

    async function fetchPlotData(table, currency, startDate, endDate) {
        const data = await fetchData(`/check-currency-range?table=${table}&currency=${currency}&start_date=${startDate}&end_date=${endDate}`);
        updatePlot(data, table, currency, startDate, endDate);
    }

    async function fetchCurrencyValue(table, currency, date) {
        try {
            const data = await fetchData(`/check-currency?table=${table}&currency=${currency}&date=${date}`);
            const rateInfoElement = document.getElementById('rateInfo');
            rateInfoElement.innerHTML = `Data: ${data.date}, Kurs: ${data.value.mid || data.value.bid + ' / ' + data.value.ask}`;
        } catch (error) {
            document.getElementById('rateInfo').innerText = "Brak danych dla podanej waluty lub daty.";
        }
    }

    function updateCurrencyDropdown(table) {
        const currencySelect = document.getElementById('currency');
        currencySelect.innerHTML = '';

        let currencies = [];
        if (table === 'A') {
            currencies = {{ currencies_a|tojson }};
        } else if (table === 'B') {
            currencies = {{ currencies_b|tojson }};
        } else if (table === 'C') {
            currencies = {{ currencies_c|tojson }};
        }

        currencies.forEach(currency => {
            const option = document.createElement('option');
            option.value = currency.code;
            option.textContent = currency.name;
            currencySelect.appendChild(option);
        });

        fetchDateRanges(table);
    }

    function updateDateRange(table) {
        const dateInput = document.getElementById('date');
        const range = dateRanges[table];
        const today = new Date();

        dateInput.min = range.min;
        dateInput.max = range.max;

        const defaultDate = new Date(range.max);
        if (defaultDate > today) {
            dateInput.value = today.toISOString().split('T')[0];
        } else {
            dateInput.value = range.max;
        }

        $("#date").datepicker("option", "minDate", new Date(range.min));
        $("#date").datepicker("option", "maxDate", new Date(range.max));

        // Trigger initial fetch of available dates for the default month and year
        const year = new Date(dateInput.value).getFullYear();
        const month = new Date(dateInput.value).getMonth() + 1;
        const currency = document.getElementById('currency').value;
        fetchAvailableDates(table, year, month, currency);
        const { startDate, endDate } = getDateRangeValues();
        fetchPlotData(table, currency, startDate, endDate);
        fetchCurrencyValue(table, currency, dateInput.value);
    }

    function highlightDatesWithRecords() {
        $("#date").datepicker("refresh");
    }

    function autoTypeDate(year, month) {
        const dateInput = document.getElementById('date');
        const firstAvailableDate = availableDates.find(date => date.startsWith(`${year}-${String(month).padStart(2, '0')}`));
        if (firstAvailableDate) {
            dateInput.value = firstAvailableDate;
        }
    }

    function getDateRangeValues() {
        const date = new Date(document.getElementById('date').value);
        let startDate, endDate;
        const rangeValue = document.querySelector('input[name="dateRange"]:checked').value;
        if (rangeValue === '1m') {
            startDate = new Date(date);
            endDate = new Date(date);
            startDate.setMonth(startDate.getMonth() - 1);
            endDate.setMonth(endDate.getMonth() + 1);
        } else if (rangeValue === '3m') {
            startDate = new Date(date);
            endDate = new Date(date);
            startDate.setMonth(startDate.getMonth() - 1.5);
            endDate.setMonth(endDate.getMonth() + 1.5);
        } else if (rangeValue === '1y') {
            startDate = new Date(date);
            endDate = new Date(date);
            startDate.setFullYear(startDate.getFullYear() - 1);
            endDate.setFullYear(endDate.getFullYear() + 1);
        }
        return {
            startDate: startDate.toISOString().split('T')[0],
            endDate: endDate.toISOString().split('T')[0]
        };
    }

    function updatePlot(data, table, currency, startDate, endDate) {
        const labels = data.map(entry => entry.date);
        let datasets = [];

        if (table === 'C') {
            const bidValues = data.map(entry => entry.value.bid);
            const askValues = data.map(entry => entry.value.ask);

            datasets = [
                {
                    label: 'Kurs kupna',
                    data: bidValues,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderWidth: 1
                },
                {
                    label: 'Kurs sprzedaÅ¼y',
                    data: askValues,
                    borderColor: 'rgba(192, 75, 75, 1)',
                    backgroundColor: 'rgba(192, 75, 75, 0.2)',
                    borderWidth: 1
                }
            ];
        } else {
            const values = data.map(entry => entry.value.mid);
            datasets = [
                {
                    label: 'Kurs Walut',
                    data: values,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderWidth: 1
                }
            ];
        }

        // Add marker for the currency date or nearest date
        const dateInput = document.getElementById('date').value;
        const nearestDate = data.find(entry => entry.date === dateInput);

        if (chart) {
            chart.destroy();
        }

        const ctx = document.getElementById('myChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            tooltipFormat: 'dd MMM yyyy'
                        }
                    },
                    y: {
                        beginAtZero: false
                    }
                },
                plugins: {
                    annotation: {
                        annotations: nearestDate ? [{
                            type: 'polygon',
                            backgroundColor: 'rgba(255, 99, 132, 0.25)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2,
                            radius: 10,
                            sides: 6,
                            xValue: nearestDate.date,
                            yValue: nearestDate.value.mid || nearestDate.value.bid,
                            label: {
                                content: 'Nearest Date',
                                enabled: true,
                                position: 'center'
                            }
                        }, ...(table === 'C' ? [{
                            type: 'polygon',
                            backgroundColor: 'rgba(99, 255, 132, 0.25)',
                            borderColor: 'rgba(99, 255, 132, 1)',
                            borderWidth: 2,
                            radius: 10,
                            sides: 6,
                            xValue: nearestDate.date,
                            yValue: nearestDate.value.ask,
                            label: {
                                content: 'Nearest Date Ask',
                                enabled: true,
                                position: 'center'
                            }
                        }] : [])] : []
                    }
                }
            }
        });
    }

    function toggleInfo(table) {
        let infoElement = document.getElementById('info-' + table);
        let allInfoElements = document.getElementsByClassName('info-box-content');
        for (let element of allInfoElements) {
            if (element !== infoElement) {
                element.style.display = 'none';
            }
        }
        infoElement.style.display = 'block';
    }

    $(document).ready(function() {
        $("#date").datepicker({
            dateFormat: 'yy-mm-dd',
            beforeShowDay: function(date) {
                const dateString = $.datepicker.formatDate('yy-mm-dd', date);
                if (availableDates.includes(dateString)) {
                    return [true, 'highlight', 'Record exists'];
                } else {
                    return [true, '', ''];
                }
            },
            onChangeMonthYear: function(year, month) {
                const table = document.querySelector('.table-btn.active').getAttribute('data-table');
                const currency = document.getElementById('currency').value;
                fetchAvailableDates(table, year, month, currency);
            }
        });

        $('#currency').on('change', function() {
            const date = $('#date').val();
            const year = new Date(date).getFullYear();
            const month = new Date(date).getMonth() + 1;
            const table = document.querySelector('.table-btn.active').getAttribute('data-table');
            const currency = document.getElementById('currency').value;
            fetchAvailableDates(table, year, month, currency).then(() => autoTypeDate(year, month));
            const { startDate, endDate } = getDateRangeValues();
            fetchPlotData(table, currency, startDate, endDate);
            fetchCurrencyValue(table, currency, date);
        });

        $('#date').on('change', function() {
            const date = $(this).val();
            const year = new Date(date).getFullYear();
            const month = new Date(date).getMonth() + 1;
            const table = document.querySelector('.table-btn.active').getAttribute('data-table');
            const currency = document.getElementById('currency').value;
            fetchAvailableDates(table, year, month, currency);
            fetchCurrencyValue(table, currency, date);
            const { startDate, endDate } = getDateRangeValues();
            fetchPlotData(table, currency, startDate, endDate);
        });

        $('.table-btn').on('click', function() {
            $('.table-btn').removeClass('active');
            $(this).addClass('active');
            const table = $(this).attr('data-table');
            updateCurrencyDropdown(table);
            const date = $('#date').val();
            const currency = document.getElementById('currency').value;
            const { startDate, endDate } = getDateRangeValues();
            fetchPlotData(table, currency, startDate, endDate);
            toggleInfo(table);
        });

        $('input[name="dateRange"]').on('change', function() {
            const table = document.querySelector('.table-btn.active').getAttribute('data-table');
            const currency = document.getElementById('currency').value;
            const { startDate, endDate } = getDateRangeValues();
            fetchPlotData(table, currency, startDate, endDate);
        });

        // Set default table to A on page load
        updateCurrencyDropdown('A');
        document.querySelector('.table-btn[data-table="A"]').classList.add('active');
        toggleInfo('A');
    });
</script>
